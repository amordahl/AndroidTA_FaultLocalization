import logging
logging.basicConfig(level=logging.DEBUG)
import subprocess
import os
import argparse
p = argparse.ArgumentParser()
p.add_argument('apk')
p.add_argument('-c', '--config',
               help='IMPORTANT: Enclose the configuration in double quotes.')
p.add_argument('-f', '--force', action='store_true',
               help='Redo experiments that are already done. Experiments that '
               'are done are determined by checking for existing output logs.')
args = p.parse_args()



def main():
    CMD = "/usr/lib/jvm/java-11-openjdk-amd64/bin/java -javaagent:/home/austin/.m2/repository/edu/utdallas/amordahl/Coverage_Instrumenter/1.0.0-SNAPSHOT/Coverage_Instrumenter-1.0.0-SNAPSHOT.jar -Dfile.encoding=UTF-8 -classpath /home/austin/git/FlowDroid/soot-infoflow-cmd/build/testclasses:/home/austin/git/FlowDroid/soot-infoflow-cmd/build/classes:/home/austin/git/AndroidTA_FaultLocalization/instrumentation/FL_Logger/target/classes:/home/austin/git/AndroidTA_FaultLocalization/instrumentation/FL_Logger/target/test-classes:/home/austin/.m2/repository/org/slf4j/slf4j-api/1.7.5/slf4j-api-1.7.5.jar:/home/austin/.m2/repository/org/jgrapht/jgrapht-core/1.4.0/jgrapht-core-1.4.0.jar:/home/austin/.m2/repository/org/jheaps/jheaps/0.11/jheaps-0.11.jar:/home/austin/.m2/repository/io/github/ali-ghanbari/object-utils/1.3/object-utils-1.3.jar:/home/austin/.p2/pool/plugins/org.junit_4.13.0.v20200204-1500.jar:/home/austin/.p2/pool/plugins/org.hamcrest.core_1.3.0.v20180420-1519.jar:/home/austin/git/FlowDroid/soot-infoflow-android/build/classes:/home/austin/git/soot/target/classes:/home/austin/git/soot/target/test-classes:/home/austin/.m2/repository/commons-io/commons-io/2.7/commons-io-2.7.jar:/home/austin/.m2/repository/org/smali/dexlib2/2.4.0/dexlib2-2.4.0.jar:/home/austin/.m2/repository/com/google/code/findbugs/jsr305/1.3.9/jsr305-1.3.9.jar:/home/austin/.m2/repository/com/google/guava/guava/27.1-android/guava-27.1-android.jar:/home/austin/.m2/repository/com/google/guava/failureaccess/1.0.1/failureaccess-1.0.1.jar:/home/austin/.m2/repository/com/google/guava/listenablefuture/9999.0-empty-to-avoid-conflict-with-guava/listenablefuture-9999.0-empty-to-avoid-conflict-with-guava.jar:/home/austin/.m2/repository/org/checkerframework/checker-compat-qual/2.5.2/checker-compat-qual-2.5.2.jar:/home/austin/.m2/repository/com/google/errorprone/error_prone_annotations/2.2.0/error_prone_annotations-2.2.0.jar:/home/austin/.m2/repository/com/google/j2objc/j2objc-annotations/1.1/j2objc-annotations-1.1.jar:/home/austin/.m2/repository/org/codehaus/mojo/animal-sniffer-annotations/1.17/animal-sniffer-annotations-1.17.jar:/home/austin/.m2/repository/org/ow2/asm/asm/8.0.1/asm-8.0.1.jar:/home/austin/.m2/repository/org/ow2/asm/asm-tree/8.0.1/asm-tree-8.0.1.jar:/home/austin/.m2/repository/org/ow2/asm/asm-util/8.0.1/asm-util-8.0.1.jar:/home/austin/.m2/repository/org/ow2/asm/asm-analysis/8.0.1/asm-analysis-8.0.1.jar:/home/austin/.m2/repository/org/ow2/asm/asm-commons/8.0.1/asm-commons-8.0.1.jar:/home/austin/.m2/repository/org/javassist/javassist/3.18.2-GA/javassist-3.18.2-GA.jar:/home/austin/.m2/repository/xmlpull/xmlpull/1.1.3.4d_b4_min/xmlpull-1.1.3.4d_b4_min.jar:/home/austin/.m2/repository/org/apache/ant/ant/1.10.9/ant-1.10.9.jar:/home/austin/.m2/repository/org/apache/ant/ant-launcher/1.10.9/ant-launcher-1.10.9.jar:/home/austin/.m2/repository/de/upb/cs/swt/axml/2.1.0-SNAPSHOT/axml-2.1.0-SNAPSHOT.jar:/home/austin/.m2/repository/ca/mcgill/sable/polyglot/2006/polyglot-2006.jar:/home/austin/git/heros/target/classes:/home/austin/git/heros/target/test-classes:/home/austin/.m2/repository/org/functionaljava/functionaljava/4.2/functionaljava-4.2.jar:/home/austin/.m2/repository/com/google/guava/guava/30.1.1-jre/guava-30.1.1-jre.jar:/home/austin/.m2/repository/com/google/code/findbugs/jsr305/3.0.2/jsr305-3.0.2.jar:/home/austin/.m2/repository/org/checkerframework/checker-qual/3.8.0/checker-qual-3.8.0.jar:/home/austin/.m2/repository/com/google/errorprone/error_prone_annotations/2.5.1/error_prone_annotations-2.5.1.jar:/home/austin/.m2/repository/com/google/j2objc/j2objc-annotations/1.3/j2objc-annotations-1.3.jar:/home/austin/.m2/repository/org/hamcrest/hamcrest-core/1.3/hamcrest-core-1.3.jar:/home/austin/.m2/repository/junit/junit/4.13.1/junit-4.13.1.jar:/home/austin/.m2/repository/org/mockito/mockito-core/3.2.4/mockito-core-3.2.4.jar:/home/austin/.m2/repository/net/bytebuddy/byte-buddy/1.10.5/byte-buddy-1.10.5.jar:/home/austin/.m2/repository/net/bytebuddy/byte-buddy-agent/1.10.5/byte-buddy-agent-1.10.5.jar:/home/austin/.m2/repository/org/objenesis/objenesis/2.6/objenesis-2.6.jar:/home/austin/.m2/repository/ca/mcgill/sable/jasmin/3.0.3-SNAPSHOT/jasmin-3.0.3-SNAPSHOT.jar:/home/austin/.m2/repository/ca/mcgill/sable/java_cup/0.9.2/java_cup-0.9.2.jar:/home/austin/.m2/repository/org/slf4j/slf4j-api/1.7.30/slf4j-api-1.7.30.jar:/home/austin/.m2/repository/org/slf4j/slf4j-simple/1.7.30/slf4j-simple-1.7.30.jar:/home/austin/.m2/repository/org/hamcrest/hamcrest-all/1.3/hamcrest-all-1.3.jar:/home/austin/.m2/repository/org/mockito/mockito-core/3.6.0/mockito-core-3.6.0.jar:/home/austin/.m2/repository/net/bytebuddy/byte-buddy/1.10.15/byte-buddy-1.10.15.jar:/home/austin/.m2/repository/net/bytebuddy/byte-buddy-agent/1.10.15/byte-buddy-agent-1.10.15.jar:/home/austin/.m2/repository/org/objenesis/objenesis/3.1/objenesis-3.1.jar:/home/austin/.m2/repository/org/powermock/powermock-api-mockito2/2.0.9/powermock-api-mockito2-2.0.9.jar:/home/austin/.m2/repository/org/powermock/powermock-api-support/2.0.9/powermock-api-support-2.0.9.jar:/home/austin/.m2/repository/org/powermock/powermock-reflect/2.0.9/powermock-reflect-2.0.9.jar:/home/austin/.m2/repository/org/powermock/powermock-core/2.0.9/powermock-core-2.0.9.jar:/home/austin/.m2/repository/org/powermock/powermock-module-junit4/2.0.9/powermock-module-junit4-2.0.9.jar:/home/austin/.m2/repository/org/powermock/powermock-module-junit4-common/2.0.9/powermock-module-junit4-common-2.0.9.jar:/home/austin/.m2/repository/com/google/android/android/4.1.1.4/android-4.1.1.4.jar:/home/austin/.m2/repository/commons-logging/commons-logging/1.1.1/commons-logging-1.1.1.jar:/home/austin/.m2/repository/org/apache/httpcomponents/httpclient/4.0.1/httpclient-4.0.1.jar:/home/austin/.m2/repository/org/apache/httpcomponents/httpcore/4.0.1/httpcore-4.0.1.jar:/home/austin/.m2/repository/commons-codec/commons-codec/1.3/commons-codec-1.3.jar:/home/austin/.m2/repository/org/khronos/opengl-api/gl1.1-android-2.1_r1/opengl-api-gl1.1-android-2.1_r1.jar:/home/austin/.m2/repository/xerces/xmlParserAPIs/2.6.2/xmlParserAPIs-2.6.2.jar:/home/austin/.m2/repository/xpp3/xpp3/1.1.4c/xpp3-1.1.4c.jar:/home/austin/.m2/repository/org/json/json/20080701/json-20080701.jar:/home/austin/.m2/repository/javax/annotation/javax.annotation-api/1.3.2/javax.annotation-api-1.3.2.jar:/home/austin/.m2/repository/javax/xml/bind/jaxb-api/2.4.0-b180725.0427/jaxb-api-2.4.0-b180725.0427.jar:/home/austin/.m2/repository/javax/activation/javax.activation-api/1.2.0/javax.activation-api-1.2.0.jar:/home/austin/.m2/repository/org/glassfish/jaxb/jaxb-runtime/2.4.0-b180830.0438/jaxb-runtime-2.4.0-b180830.0438.jar:/home/austin/.m2/repository/org/glassfish/jaxb/txw2/2.4.0-b180830.0438/txw2-2.4.0-b180830.0438.jar:/home/austin/.m2/repository/com/sun/istack/istack-commons-runtime/3.0.7/istack-commons-runtime-3.0.7.jar:/home/austin/.m2/repository/org/jvnet/staxex/stax-ex/1.8/stax-ex-1.8.jar:/home/austin/.m2/repository/com/sun/xml/fastinfoset/FastInfoset/1.2.15/FastInfoset-1.2.15.jar:/home/austin/git/FlowDroid/soot-infoflow/build/classes:/home/austin/git/FlowDroid/soot-infoflow/build/testclasses:/home/austin/git/FlowDroid/soot-infoflow/lib/cos.jar:/home/austin/git/FlowDroid/soot-infoflow/lib/j2ee.jar:/home/austin/git/FlowDroid/soot-infoflow-android/lib/protobuf-java-2.5.0.jar:/home/austin/.m2/repository/net/sf/trove4j/trove4j/3.0.3/trove4j-3.0.3.jar:/home/austin/.m2/repository/ca/mcgill/sable/jasmin/2.5.0-SNAPSHOT/jasmin-2.5.0-SNAPSHOT.jar:/home/austin/.m2/repository/pxb/android/axml/2.0.0-SNAPSHOT/axml-2.0.0-SNAPSHOT.jar:/home/austin/.m2/repository/ca/mcgill/sable/axmlprinter/2016-07-27/axmlprinter-2016-07-27.jar:/home/austin/.m2/repository/com/google/protobuf/protobuf-java/2.5.0/protobuf-java-2.5.0.jar:/home/austin/git/FlowDroid/soot-infoflow-summaries/build/classes:/home/austin/.m2/repository/com/google/guava/guava/25.1-jre/guava-25.1-jre.jar:/home/austin/.m2/repository/org/checkerframework/checker-qual/2.0.0/checker-qual-2.0.0.jar:/home/austin/.m2/repository/com/google/errorprone/error_prone_annotations/2.1.3/error_prone_annotations-2.1.3.jar:/home/austin/.m2/repository/org/codehaus/mojo/animal-sniffer-annotations/1.14/animal-sniffer-annotations-1.14.jar:/home/austin/.m2/repository/heros/heros/1.0.1-SNAPSHOT/heros-1.0.1-SNAPSHOT.jar:/home/austin/.m2/repository/ca/mcgill/sable/soot/3.2.0/soot-3.2.0.jar:/home/austin/.m2/repository/commons-io/commons-io/2.6/commons-io-2.6.jar:/home/austin/.m2/repository/org/smali/dexlib2/2.2.5/dexlib2-2.2.5.jar:/home/austin/.m2/repository/org/ow2/asm/asm-debug-all/5.2/asm-debug-all-5.2.jar:/home/austin/.m2/repository/commons-cli/commons-cli/1.4/commons-cli-1.4.jar:/home/austin/.m2/repository/org/slf4j/slf4j-simple/1.7.5/slf4j-simple-1.7.5.jar soot.jimple.infoflow.cmd.MainClass -a {apk} -s /home/austin/git/FlowDroid/soot-infoflow-android/SourcesAndSinks.txt -p /home/austin/Android/Sdk/platforms {config}"
    
    # Replace strings in cmd.
    base_apk : str = os.path.basename(args.apk).replace('.apk', '')
    CMD = CMD.replace('{apk}', args.apk)
    output_file = f'{base_apk}_default' if args.config == None else \
        f'{base_apk}_{args.config.replace(" ","_").replace("/","_").replace("-","")}'
    if output_file[-1] == '_':
        output_file = output_file[0:-2]

    output_file = output_file + '.instlog'
        
    CMD = CMD.replace('{config}', args.config if args.config != None else '')
    logging.debug(f'CMD is {CMD}')
    if not args.force:
        if os.path.exists(output_file):
            with open(output_file, 'r') as infile:
                lines = infile.readlines()
                if lines[-1] == 'DONE\n':
                    exit(0)
    with open(output_file, 'w') as outfile:
        subprocess.run(CMD.split(), stdout=outfile)
    with open(output_file, 'a') as outfile:
        outfile.write('DONE\n')
    
    
if __name__ == '__main__':
    main()
